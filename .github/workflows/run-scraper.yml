name: Run IMDb Scraper

on:
  workflow_dispatch:

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Run ECS Task
        run: |
          TASK_ARN=$(aws ecs run-task \
            --cluster imdb-scraper \
            --task-definition imdb-scraper \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ secrets.ECS_SUBNETS }}],securityGroups=[${{ secrets.ECS_SECURITY_GROUPS }}],assignPublicIp=ENABLED}" \
            --overrides '{
              "containerOverrides": [{
                "name": "app",
                "environment": [
                  {"name": "SCRAPE_URL", "value": "${{ secrets.SCRAPE_URL }}"},
                  {"name": "S3_BUCKET", "value": "${{ secrets.S3_BUCKET }}"},
                  {"name": "S3_PREFIX", "value": "${{ secrets.S3_PREFIX }}"},
                  {"name": "AWS_REGION", "value": "${{ secrets.AWS_REGION }}"}
                ]
              }]
            }' \
            --query 'tasks[0].taskArn' \
            --output text)
          
          echo "Task ARN: $TASK_ARN"
          echo "‚úÖ Scraper task started successfully!"
          echo ""
          echo "üìä Monitor task progress:"
          echo "  - AWS Console: https://console.aws.amazon.com/ecs/home?region=${{ secrets.AWS_REGION }}#/clusters/imdb-scraper/tasks"
          echo "  - CloudWatch Logs: https://console.aws.amazon.com/cloudwatch/home?region=${{ secrets.AWS_REGION }}#logsV2:log-groups"
          echo ""
          echo "üîç Check task status:"
          echo "  aws ecs describe-tasks --cluster imdb-scraper --tasks $TASK_ARN"
          echo ""
          echo "üìã View logs:"
          echo "  aws logs tail /aws/ecs/imdb-scraper --follow"
          echo ""
          echo "‚è±Ô∏è The task will run independently and may take several hours to complete."
          echo "   Check S3 bucket for output: s3://${{ secrets.S3_BUCKET }}/${{ secrets.S3_PREFIX }}"
